# 实现全量历史资金流同步服务

## 1. 新建 `services/sync_service.go`

创建一个新的服务文件 `services/sync_service.go`，用于处理全市场的历史资金流数据同步。

### 1.1 定义数据结构
- **`SyncService`**: 包含 `DBService`, `StockMarketService`, `MoneyFlowRepository` 和 `http.Client`。
- **`SyncProgress`**: 定义用于前端展示的进度结构体。
    ```go
    type SyncProgress struct {
        Total        int     `json:"total"`
        Current      int     `json:"current"`
        CurrentStock string  `json:"currentStock"`
        Status       string  `json:"status"` // "running", "completed", "error"
        SuccessCount int     `json:"successCount"`
        FailedCount  int     `json:"failedCount"`
    }
    ```

### 1.2 实现 `NewSyncService`
- 初始化服务，注入必要的依赖。

## 2. 实现核心逻辑 `FetchAndSaveHistoryFlow`

该函数负责获取单个股票的历史资金流数据并保存。

- **构建请求 URL**:
    - 使用东财接口: `https://push2his.eastmoney.com/api/qt/stock/fflow/daykline/get`
    - 参数: `lmt=0` (获取全部), `klt=101` (日线), `secid` (带市场前缀的代码)。
- **解析响应**:
    - 解析 JSON 数据，映射字段：
        - `f51` -> `TradeDate`
        - `f52` -> `MainNet` (主力净流入)
        - `f56` -> `SuperNet` (超大单)
        - `f55` -> `BigNet` (大单)
        - `f54` -> `MidNet` (中单)
        - `f53` -> `SmallNet` (小单)
        - `f62` -> `ClosePrice`
        - `f63` -> `ChgPct`
- **数据保存**:
    - 调用 `MoneyFlowRepository.SaveMoneyFlows` 批量插入数据库。

## 3. 实现 `StartFullMarketSync`

该函数作为入口，调度全市场同步任务。

- **获取股票列表**: 调用 `StockMarketService.GetAllStockCodes()`。
- **并发控制**:
    - 使用 `sync.WaitGroup` 和带有缓冲的 Channel (大小为 5) 来限制并发数为 5。
- **任务执行**:
    - 遍历股票代码列表。
    - 启动 Goroutine 执行 `FetchAndSaveHistoryFlow`。
    - 每次请求后休眠 200ms (`time.Sleep`).
- **进度广播**:
    - 使用 `runtime.EventsEmit(ctx, "sync_progress", progress)` 每完成一个任务推送一次进度。
- **错误处理**:
    - 记录失败的股票，但不中断整体流程。

## 4. 更新 `App` 结构体和初始化

- 在 `App` 结构体中添加 `SyncService`。
- 在 `NewApp` 中初始化 `SyncService`。
- 暴露 `StartFullMarketSync` 方法给前端调用。
